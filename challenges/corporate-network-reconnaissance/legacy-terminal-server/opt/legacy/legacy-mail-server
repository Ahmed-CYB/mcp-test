#!/bin/bash
# Legacy mail server daemon
# Vulnerable to directory traversal - DO NOT EXPOSE TO INTERNET

echo "220 legacy-terminal-server ESMTP Legacy Mail Server 1.2.3"

while read line; do
    case "$line" in
        HELO*|EHLO*)
            echo "250 legacy-terminal-server Hello, pleased to meet you"
            ;;
        HELP*)
            echo "214 Commands: HELO EHLO MAIL RCPT DATA HELP QUIT ADMIN"
            echo "214 Special: ADMIN allows file access for troubleshooting"
            ;;
        ADMIN*)
            file=$(echo "$line" | cut -d' ' -f2-)
            if [[ "$file" == *".."* ]]; then
                # Directory traversal vulnerability
                realfile=$(echo "$file" | sed 's/\.\.\/\.\.\/\.\.\/\.\.\/\.\.\/\.\.\//..\/..\/..\//')
                if [ -f "/opt/legacy/data/$realfile" ]; then
                    echo "250 File contents:"
                    cat "/opt/legacy/data/$realfile"
                else
                    echo "550 File not found"
                fi
            else
                echo "550 Access denied - relative paths only"
            fi
            ;;
        QUIT*)
            echo "221 Goodbye"
            exit 0
            ;;
        *)
            echo "500 Command not recognized"
            ;;
    esac
done