FROM kalilinux/kali-rolling

ENV DEBIAN_FRONTEND=noninteractive

# CRITICAL: Always update package lists before installing
# Update and install base tools + SSH
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    openssh-server \
    sudo \
    vim \
    nano \
    curl \
    wget \
    git \
    net-tools \
    iputils-ping \
    ca-certificates \
    unzip \
    python3 \
    python3-pip \
    nmap \
    smbclient \
    enum4linux \
    samba-common-bin \
    smbmap \
    crackmapexec \
    masscan \
    wireshark \
    netcat-traditional \
    tcpdump \
    arp-scan \
    hping3 \
    netdiscover \
    traceroute \
    dnsutils \
    whois \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Configure SSH server
RUN mkdir -p /var/run/sshd && \
    echo 'root:toor' | chpasswd && \
    useradd -m -s /bin/bash kali && \
    echo 'kali:kali' | chpasswd && \
    usermod -aG sudo kali && \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

# âœ… FIX: Replace nmap wrapper to always use unprivileged mode
# The default /usr/bin/nmap wrapper tries to use --privileged which requires capabilities
# We replace it with a wrapper that always uses --unprivileged mode
RUN mv /usr/bin/nmap /usr/bin/nmap.original 2>/dev/null || true && \
    echo '#!/bin/bash' > /usr/bin/nmap && \
    echo '# Nmap wrapper - always use unprivileged mode (no CAP_NET_RAW required)' >> /usr/bin/nmap && \
    echo 'exec /usr/lib/nmap/nmap --unprivileged "$@"' >> /usr/bin/nmap && \
    chmod +x /usr/bin/nmap

# ðŸ”’ SECURITY: Install iptables for network isolation
RUN apt-get update && \
    apt-get install -y --no-install-recommends iptables && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# ðŸ”’ SECURITY: Create network isolation script to block gateway and infrastructure access
RUN echo '#!/bin/bash' > /usr/local/bin/secure-network.sh && \
    echo 'set -e' >> /usr/local/bin/secure-network.sh && \
    echo '' >> /usr/local/bin/secure-network.sh && \
    echo '# Get gateway IP from default route' >> /usr/local/bin/secure-network.sh && \
    echo 'GATEWAY=$(ip route | grep default | awk '"'"'{print $3}'"'"' | head -1)' >> /usr/local/bin/secure-network.sh && \
    echo 'if [ -z "$GATEWAY" ]; then' >> /usr/local/bin/secure-network.sh && \
    echo '  # Fallback: extract from interface IP (assume .1 is gateway)' >> /usr/local/bin/secure-network.sh && \
    echo '  MY_IP=$(hostname -I | awk '"'"'{print $1}'"'"')' >> /usr/local/bin/secure-network.sh && \
    echo '  GATEWAY=$(echo $MY_IP | cut -d. -f1-3).1' >> /usr/local/bin/secure-network.sh && \
    echo 'fi' >> /usr/local/bin/secure-network.sh && \
    echo '' >> /usr/local/bin/secure-network.sh && \
    echo '# Block gateway access (except DNS on port 53)' >> /usr/local/bin/secure-network.sh && \
    echo 'if [ ! -z "$GATEWAY" ]; then' >> /usr/local/bin/secure-network.sh && \
    echo '  echo "ðŸ”’ Blocking gateway access: $GATEWAY"' >> /usr/local/bin/secure-network.sh && \
    echo '  iptables -A OUTPUT -d $GATEWAY -p udp --dport 53 -j ACCEPT' >> /usr/local/bin/secure-network.sh && \
    echo '  iptables -A OUTPUT -d $GATEWAY -j DROP' >> /usr/local/bin/secure-network.sh && \
    echo 'fi' >> /usr/local/bin/secure-network.sh && \
    echo '' >> /usr/local/bin/secure-network.sh && \
    echo '# Block Guacamole network (172.22.0.0/16) - infrastructure isolation' >> /usr/local/bin/secure-network.sh && \
    echo 'echo "ðŸ”’ Blocking Guacamole network: 172.22.0.0/16"' >> /usr/local/bin/secure-network.sh && \
    echo 'iptables -A OUTPUT -d 172.22.0.0/16 -j DROP' >> /usr/local/bin/secure-network.sh && \
    echo '' >> /usr/local/bin/secure-network.sh && \
    echo '# Block other infrastructure networks' >> /usr/local/bin/secure-network.sh && \
    echo 'echo "ðŸ”’ Blocking infrastructure networks"' >> /usr/local/bin/secure-network.sh && \
    echo 'iptables -A OUTPUT -d 172.20.0.0/16 -j DROP' >> /usr/local/bin/secure-network.sh && \
    echo 'iptables -A OUTPUT -d 172.21.0.0/16 -j DROP' >> /usr/local/bin/secure-network.sh && \
    echo '' >> /usr/local/bin/secure-network.sh && \
    echo 'echo "âœ… Network isolation rules applied"' >> /usr/local/bin/secure-network.sh && \
    chmod +x /usr/local/bin/secure-network.sh

# Create challenge directory
RUN mkdir -p /challenge && chmod 755 /challenge

EXPOSE 22

# ðŸ”’ SECURITY: Apply network isolation on container start
RUN echo '#!/bin/bash' > /start-secure.sh && \
    echo 'set -e' >> /start-secure.sh && \
    echo '' >> /start-secure.sh && \
    echo '# Apply network isolation rules' >> /start-secure.sh && \
    echo '/usr/local/bin/secure-network.sh' >> /start-secure.sh && \
    echo '' >> /start-secure.sh && \
    echo '# Start SSH daemon' >> /start-secure.sh && \
    echo 'exec /usr/sbin/sshd -D' >> /start-secure.sh && \
    chmod +x /start-secure.sh

CMD ["/start-secure.sh"]
