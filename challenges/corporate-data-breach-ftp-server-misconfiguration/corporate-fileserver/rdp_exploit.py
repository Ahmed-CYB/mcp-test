#!/usr/bin/env python3
"""
RDP Security Assessment Tool
Demonstrates common RDP misconfigurations
"""

import socket
import sys
import time
from struct import pack, unpack

def check_rdp_service(host, port):
    """Check if RDP service is running and get basic info"""
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(5)
        result = sock.connect_ex((host, port))
        if result == 0:
            print(f"[+] RDP service detected on {host}:{port}")
            
            # Send RDP connection request
            rdp_request = b'\x03\x00\x00\x13\x0e\xe0\x00\x00\x00\x00\x00\x01\x00\x08\x00\x00\x00\x00\x00'
            sock.send(rdp_request)
            response = sock.recv(1024)
            
            if len(response) > 0:
                print(f"[+] RDP service responded with {len(response)} bytes")
                print(f"[*] Response: {response[:50].hex()}...")
                
                # Check for weak encryption indicators
                if b'\x01\x00' in response:
                    print("[!] WARNING: Weak encryption detected")
                if b'\x00\x00' in response[10:15]:
                    print("[!] WARNING: No certificate validation")
                    
                return True
            else:
                print(f"[-] No response from RDP service")
                return False
        else:
            print(f"[-] Cannot connect to {host}:{port}")
            return False
    except Exception as e:
        print(f"[-] Error checking RDP service: {e}")
        return False
    finally:
        sock.close()

def brute_force_rdp(host, port, usernames, passwords):
    """Attempt basic credential brute force"""
    print(f"[*] Attempting credential brute force on {host}:{port}")
    
    for username in usernames:
        for password in passwords:
            print(f"[*] Trying {username}:{password}")
            # In real implementation, this would attempt RDP authentication
            # For demonstration, we simulate the process
            time.sleep(0.1)
            
            if username == "backup_admin" and password == "BackupSys2023":
                print(f"[+] SUCCESS! Credentials found: {username}:{password}")
                return username, password
    
    print("[-] No valid credentials found in wordlist")
    return None, None

def analyze_rdp_security(host, port):
    """Analyze RDP service security configuration"""
    print(f"\n[*] Analyzing RDP security configuration on {host}:{port}")
    
    # Check service availability
    if not check_rdp_service(host, port):
        return False
    
    # Common RDP usernames and passwords
    usernames = ['administrator', 'admin', 'backup_admin', 'user', 'guest']
    passwords = ['password', 'admin', 'BackupSys2023', '123456', 'password123']
    
    # Attempt brute force
    username, password = brute_force_rdp(host, port, usernames, passwords)
    
    if username and password:
        print(f"\n[+] RDP Access Gained!")
        print(f"[+] Use these credentials to connect:")
        print(f"    Username: {username}")
        print(f"    Password: {password}")
        print(f"    Command: rdesktop -u {username} -p {password} {host}:{port}")
        print(f"    Or: xfreerdp /u:{username} /p:{password} /v:{host}:{port}")
        return True
    
    return False

if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("Usage: python3 rdp_exploit.py <host> <port>")
        print("Example: python3 rdp_exploit.py 192.168.1.100 29")
        sys.exit(1)
    
    host = sys.argv[1]
    port = int(sys.argv[2])
    
    print("RDP Security Assessment Tool")
    print("============================\n")
    
    if analyze_rdp_security(host, port):
        print("\n[!] RDP service is vulnerable to credential attacks")
        print("[!] Recommendations:")
        print("    - Enable Network Level Authentication")
        print("    - Use strong passwords")
        print("    - Implement account lockout policies")
        print("    - Use certificate-based authentication")
        print("    - Enable proper encryption")
    else:
        print("\n[*] Could not exploit RDP service with basic techniques")